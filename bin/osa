#!/usr/bin/env bash
# bin/osa — One command to start OSA with the Go TUI.
#
# Starts the Elixir backend in the background, waits for it to be healthy,
# launches the Go TUI, and tears down the backend when you quit.
#
# Usage:
#   bin/osa                    # default
#   bin/osa --dev              # dev profile + port 19001
#   bin/osa --profile staging  # named profile

set -euo pipefail

ROOT="$(cd "$(dirname "$0")/.." && pwd)"
TUI_DIR="$ROOT/priv/go/tui"
TUI_BIN="$TUI_DIR/osa"
LOG_DIR="${HOME}/.osa/logs"
BACKEND_PID=""

mkdir -p "$LOG_DIR"

cleanup() {
  if [ -n "$BACKEND_PID" ] && kill -0 "$BACKEND_PID" 2>/dev/null; then
    kill "$BACKEND_PID" 2>/dev/null
    wait "$BACKEND_PID" 2>/dev/null || true
  fi
}
trap cleanup EXIT INT TERM

# ── Build Go TUI if needed ──────────────────────────────────────
if [ ! -f "$TUI_BIN" ]; then
  echo "Building Go TUI…"
  (cd "$TUI_DIR" && make build)
  echo ""
fi

# ── Determine port ──────────────────────────────────────────────
PORT="${OSA_PORT:-8089}"
for arg in "$@"; do
  if [ "$arg" = "--dev" ]; then
    PORT="${OSA_PORT:-19001}"
    break
  fi
done

# ── Check if backend is already running ─────────────────────────
URL="http://localhost:${PORT}/health"
if curl -sf "$URL" >/dev/null 2>&1; then
  echo "Backend already running on :${PORT}"
else
  # Check if port is occupied by something else
  if lsof -i ":${PORT}" -sTCP:LISTEN >/dev/null 2>&1; then
    echo "Port ${PORT} is in use. Killing previous instance…"
    lsof -ti ":${PORT}" -sTCP:LISTEN | xargs kill -9 2>/dev/null || true
    sleep 1
  fi

  export MIX_ENV="${MIX_ENV:-dev}"
  LOG_FILE="$LOG_DIR/backend.log"
  echo "Starting backend on :${PORT}…"

  if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" || "$OSTYPE" == "win32" ]]; then
    # Windows (Git Bash / MSYS2 / Cygwin): redirect all I/O to prevent
    # prim_tty crash — backgrounding detaches the console handle and
    # Erlang's prim_tty fails with:
    #   {case_clause,{error,{'SetConsoleModeInitIn','The handle is invalid.'}}}
    (cd "$ROOT" && elixir --no-halt \
      -e "Application.put_env(:elixir, :ansi_enabled, false)" \
      -S mix osa.serve) </dev/null >"$LOG_FILE" 2>&1 &
  else
    # Unix: backend is backgrounded; send output to log file to keep
    # the terminal clean for the TUI.
    (cd "$ROOT" && mix osa.serve) >"$LOG_FILE" 2>&1 &
  fi
  BACKEND_PID=$!
fi

# ── Wait for health ─────────────────────────────────────────────
attempts=0
max_attempts=30

while [ $attempts -lt $max_attempts ]; do
  if curl -sf "$URL" >/dev/null 2>&1; then
    break
  fi
  attempts=$((attempts + 1))
  sleep 1
done

if [ $attempts -eq $max_attempts ]; then
  echo "Backend did not become healthy after ${max_attempts}s."
  echo "Check logs: $LOG_DIR/backend.log"
  exit 1
fi

# ── Launch TUI ──────────────────────────────────────────────────
export OSA_URL="http://localhost:${PORT}"
exec "$TUI_BIN" "$@"
